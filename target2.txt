//@version=5
indicator("AUTO System + Toggles + SL TP + Table", overlay=true, max_labels_count=50)

// ===== TOGGLES =====
showBuySell   = input.bool(true, "Show Buy / Sell Signals")
showSLTP      = input.bool(true, "Show SL & Target")
showTable     = input.bool(true, "Show Info Table (Mobile)")
useVolume     = input.bool(true, "Use Volume Filter")
useBollinger  = input.bool(true, "Use Bollinger Filter")
showNifty     = input.bool(true, "Show NIFTY Trend")

// ===== INDICATORS =====
rsi = ta.rsi(close, 14)
k   = ta.stoch(close, high, low, 14)

volMA = ta.sma(volume, 20)
volCond = volume > volMA or not useVolume

// Bollinger Bands
basis = ta.sma(close, 20)
dev   = ta.stdev(close, 20) * 2
upper = basis + dev
lower = basis - dev

bbBuy  = close < lower or not useBollinger
bbSell = close > upper or not useBollinger

// ATR
atr = ta.atr(14)

// ===== SIGNALS =====
buySignal  = showBuySell and k < 20 and rsi < 30 and volCond and bbBuy
sellSignal = showBuySell and k > 80 and rsi > 70 and volCond and bbSell

// ===== AUTO SL / TP =====
buySL = close - atr * 1.5
buyTP = close + atr * 3

sellSL = close + atr * 1.5
sellTP = close - atr * 3

// ===== PLOTS =====
plotshape(buySignal, style=shape.triangledown, location=location.belowbar, color=color.green, size=size.small, text="BUY")
plotshape(sellSignal, style=shape.triangleup, location=location.abovebar, color=color.red, size=size.small, text="SELL")
plot(useBollinger ? upper : na, "BB Upper", color=color.orange)
plot(useBollinger ? basis : na, "BB Basis", color=color.gray)
plot(useBollinger ? lower : na, "BB Lower", color=color.orange)
plot(showSLTP and buySignal  ? buySL  : na, "Buy SL",  color=color.red, linewidth=2)
plot(showSLTP and buySignal  ? buyTP  : na, "Buy TP",  color=color.green, linewidth=2)
plot(showSLTP and sellSignal ? sellSL : na, "Sell SL", color=color.red, linewidth=2)
plot(showSLTP and sellSignal ? sellTP : na, "Sell TP", color=color.green, linewidth=2)

// ===== NIFTY TREND =====
niftyClose = request.security("NSE:NIFTY", timeframe.period, close)
niftyEMA   = request.security("NSE:NIFTY", timeframe.period, ta.ema(close, 50))
niftyTrend = niftyClose > niftyEMA ? "BULLISH" : "BEARISH"

// ===== SESSION DELTA =====
buyVol  = close > open ? volume : 0
sellVol = close < open ? volume : 0
delta   = buyVol - sellVol
deltaTxt = delta > 0 ? "+" + str.tostring(delta) : str.tostring(delta)

// ===== TABLE (MOBILE OPTIMIZED) =====
var table t = table.new(position.bottom_right, 2, 5, frame_width=1)

if barstate.islast and showTable
    table.cell(t, 0, 0, "RSI", text_size=size.tiny)
    table.cell(t, 1, 0, str.tostring(rsi, "#.##"), text_size=size.tiny)

    table.cell(t, 0, 1, "NIFTY", text_size=size.tiny)
    table.cell(t, 1, 1, showNifty ? niftyTrend + " " + str.tostring(niftyClose, "#") : "OFF", text_size=size.tiny)

    table.cell(t, 0, 2, "Delta", text_size=size.tiny)
    table.cell(t, 1, 2, deltaTxt, text_size=size.tiny, text_color = delta > 0 ? color.green : color.red)

    table.cell(t, 0, 3, "Target", text_size=size.tiny)
    table.cell(t, 1, 3, buySignal ? str.tostring(buyTP, "#.##") : sellSignal ? str.tostring(sellTP, "#.##") : "-", text_size=size.tiny)

    table.cell(t, 0, 4, "Stoploss", text_size=size.tiny)
    table.cell(t, 1, 4, buySignal ? str.tostring(buySL, "#.##") : sellSignal ? str.tostring(sellSL, "#.##") : "-", text_size=size.tiny)
